<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>é€šå‹¤ã‚­ãƒ¼ãƒ‘ãƒ¼</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; font-family: sans-serif; }

        /* â–¼â–¼â–¼ ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆç´«ãƒ˜ãƒƒãƒ€ãƒ¼ãªã©ï¼‰ã¯ãã®ã¾ã¾ç¶­æŒ â–¼â–¼â–¼ */
        .header-status { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-depart { width: 180px; height: 180px; border-radius: 50%; font-size: 1.5rem; font-weight: bold; color: white; border: none; background: linear-gradient(145deg, #28a745, #218838); box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4); margin: 20px auto; display: block; }
        .btn-depart.disabled { background: #ccc; box-shadow: none; pointer-events: none; }
        .card-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* å¤©æ°—ã‚«ãƒ¼ãƒ‰ (æ–°ãƒ‡ã‚¶ã‚¤ãƒ³) */
        .weather-info { font-size: 1.0rem; color: #333; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .weather-icon-large { font-size: 3.5rem; line-height: 1; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .temp-high { color: #e74c3c; font-weight: bold; font-size: 1.2rem; }
        .temp-low { color: #3498db; font-weight: bold; font-size: 1.2rem; }
        .clothing-advice { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }

        /* é…åˆ»ã‚¢ãƒ©ãƒ¼ãƒˆ */
        #lateAlert { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.95); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .btn-sms { background: white; color: #d9534f; font-weight: bold; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; text-decoration: none; margin-top: 20px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* â–¼â–¼â–¼ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (æ›œæ—¥å¯¾å¿œç‰ˆ) â–¼â–¼â–¼ */
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.9rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-day { height: 40px; background: #f1f3f5; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; position: relative; color: #333; }

        /* æ›œæ—¥ãƒ»ç¥æ—¥ã‚«ãƒ©ãƒ¼ */
        .sat { background-color: #e6f0ff; color: blue; } /* åœŸæ›œ */
        .sun { background-color: #ffe6e6; color: red; } /* æ—¥æ›œ */
        .holiday { background-color: #ffe6e6; color: red; } /* ç¥æ—¥ */
        .today { border: 2px solid #333; font-weight: bold; }

        /* ã‚¹ã‚¿ãƒ³ãƒ— */
        .calendar-day.stamped { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .stamp-mark { position: absolute; font-size: 1.5rem; opacity: 0.8; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        input[type="time"], input[type="tel"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.2rem; text-align: center; }
        select.form-control { height: 50px; font-size: 1.1rem; border-radius: 8px; }
    </style>
</head>
<body>

<div id="lateAlert">
    <h1 style="font-size: 4rem;">ğŸš¨</h1>
    <h2>é…åˆ»æ³¨æ„ï¼</h2>
    <p>å‡ºç™ºäºˆå®šæ™‚é–“ã‚’éãã¦ã„ã¾ã™ã€‚<br>ãƒªãƒ¼ãƒ€ãƒ¼ã«é€£çµ¡ã—ã¾ã™ã‹ï¼Ÿ</p>
    <a id="autoSmsLink" href="#" class="btn-sms">ğŸ“© SMSã‚’èµ·å‹•</a>
    <button onclick="closeAlert()" class="btn btn-outline-light btn-sm mt-4">é–‰ã˜ã‚‹</button>
</div>

<div class="header-status">
    <div>é€£ç¶šé”æˆ</div>
    <div style="font-size: 3rem; font-weight: bold;">
        <span id="streak-count">0</span>æ—¥ </div>
    <div style="font-size: 0.9rem;">
        <span id="user-name-display">ãŸãªã‹</span> ã•ã‚“
    </div>
    <div style="font-size:0.8rem; margin-top:5px; opacity:0.8;">(æ”¹) ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
</div>

<div class="container mt-3">
    <div class="card-box">
        <h6 class="border-bottom pb-2 mb-2">â˜€ ä»Šæ—¥ã®å¤©æ°—ã¨æœè£…</h6>
        <div class="form-group">
            <select id="location-select" class="form-control" onchange="updateWeather()" style="height: auto; padding: 5px; font-size: 1rem;">
                <option value="34.69,135.50">å¤§é˜ª (Osaka)</option>
                <option value="35.01,135.76">äº¬éƒ½ (Kyoto)</option>
                <option value="34.69,135.19">å…µåº« (Kobe)</option>
                <option value="34.23,135.17">å’Œæ­Œå±± (Wakayama)</option> <option value="35.00,135.87">æ»‹è³€ (Otsu)</option>     <option value="34.69,135.80">å¥ˆè‰¯ (Nara)</option>       <option value="35.69,139.69">æ±äº¬ (Tokyo)</option>
            </select>
        </div>
        <div id="weather-display" style="text-align:center;">
            <div id="weather-icon-area" class="weather-icon-large">Loading...</div>
            <div class="weather-info" id="weather-info"></div>
            <div class="clothing-advice" id="clothing-advice">ğŸ§¥ ...</div>
        </div>
    </div>

    <div class="text-center mb-4">
        <form action="/depart" method="post" onsubmit="handleDepartClick()">
            <input type="hidden" name="user" value="ãŸãªã‹">
            <button type="submit" id="btn-depart-main" class="btn-depart">
                å‡ºç™ºï¼
            </button>
        </form>

        <a id="manualSmsLink" href="#" class="btn btn-outline-danger btn-sm mt-3 px-4 py-2 font-weight-bold" style="border-radius: 50px;">
            ğŸ“© ãƒªãƒ¼ãƒ€ãƒ¼ã¸é€£çµ¡ (SMS)
        </a>
    </div>

    <div class="card-box">
        <h6 class="border-bottom pb-2 mb-3">ğŸ“… é€£ç¶šé”æˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (<span id="cal-title"></span>)</h6>

        <div class="calendar-header">
            <div style="color:red">æ—¥</div>
            <div>æœˆ</div>
            <div>ç«</div>
            <div>æ°´</div>
            <div>æœ¨</div>
            <div>é‡‘</div>
            <div style="color:blue">åœŸ</div>
        </div>

        <div id="calendar-grid" class="calendar-grid">
            </div>
    </div>

    <div class="alert alert-success mt-3 shadow-sm">
        <strong>âœ… è¨­å®šä¿å­˜å®Œäº†</strong><br>
        <span style="font-size: 0.9rem;">Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é€šçŸ¥ã‚’äºˆç´„ï¼š</span>
        <a href="http://www.google.com/calendar/event?action=TEMPLATE&text=ãã‚ãã‚å‡ºç™ºã®æ™‚é–“ã§ã™ï¼" target="_blank" class="btn btn-success btn-block mt-2 font-weight-bold">
            ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«é€šçŸ¥ã‚»ãƒƒãƒˆ
        </a>
    </div>

    <form action="/config/save" method="post">
        <input type="hidden" id="userName" name="userName" value="ãŸãªã‹">
        <div class="card-box">
            <details open>
                <summary style="font-weight:bold; cursor:pointer;">âš™ï¸ è¨­å®š</summary>
                <div class="mt-3">
                    <label>ğŸ  å‡ºç™ºäºˆå®šæ™‚é–“</label>
                    <input type="time" required id="departureTime" name="departureTime" value="08:00">
                </div>
                <div class="mt-3">
                    <label>ğŸ”” é€šçŸ¥ (Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº)</label>
                    <select class="form-control" id="notificationMinutesBefore" name="notificationMinutesBefore">
                        <option value="5">5åˆ†å‰</option>
                        <option value="10">10åˆ†å‰</option>
                        <option value="15" selected="selected">15åˆ†å‰</option>
                    </select>
                </div>
                <div class="mt-3">
                    <label>ğŸš¨ ãƒªãƒ¼ãƒ€ãƒ¼ã®é›»è©±ç•ªå· (å¿…é ˆ)</label>
                    <input type="tel" placeholder="09012345678" id="leaderPhoneNumber" name="leaderPhoneNumber" value="">
                </div>
                <button type="submit" class="btn btn-secondary btn-block mt-4">è¨­å®šã‚’ä¿å­˜ã—ã¦æ›´æ–°</button>
            </details>
        </div>
    </form>
</div>

<script>
    // --- è¨­å®šå€¤ (ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹å€¤ãŒã‚ã‚‹å ´åˆã¯æ›¸ãæ›ãˆã¦ãã ã•ã„) ---
    const departureTimeStr = "08:00:00";
    const leaderPhone = null;
    const userName = "ãŸãªã‹";

    let isAlertClosed = false;

    // --- 1. é€£ç¶šé”æˆã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ (å¹³æ—¥ã®ã¿ãƒªã‚»ãƒƒãƒˆ) ---
    function initStreakLogic() {
        // LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        let count = parseInt(localStorage.getItem('streakCount')) || 0;
        let lastDate = localStorage.getItem('lastVisitDate');
        const todayStr = new Date().toDateString(); // "Fri Dec 08 2025"
        const dayOfWeek = new Date().getDay(); // 0:æ—¥, 6:åœŸ

        // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ã‚‹å ´åˆ
        if (lastDate !== todayStr) {
            // åœŸ(6) ã¾ãŸã¯ æ—¥(0) ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ (ç¶­æŒ)
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                console.log("åœŸæ—¥ã®ãŸã‚ã‚«ã‚¦ãƒ³ãƒˆç¶­æŒ");
            } else {
                // å¹³æ—¥ã¯ãƒªã‚»ãƒƒãƒˆ (å‰æ—¥ã«å‡ºç™ºã—ã¦ãªã‘ã‚Œã°0ã€ãªã©ã®ç´°ã‹ã„åˆ¤å®šã‚‚å¯èƒ½ã§ã™ãŒä»Šå›ã¯å˜ç´”ã«)
                // â€»æœ¬æ¥ã¯ã€Œæ˜¨æ—¥æŠ¼ã—ãŸã‹ã€ã‚’åˆ¤å®šã™ã¹ãã§ã™ãŒã€ç°¡æ˜“çš„ã«ã€Œå¹³æ—¥ãƒªã‚»ãƒƒãƒˆã€ã¨ã—ã¾ã™
                // ã‚‚ã—ã€Œæ˜¨æ—¥æŠ¼ã—ã¦ãŸã‚‰ç¶™ç¶šã€ã«ã—ãŸã„å ´åˆã€isDepartedãƒ•ãƒ©ã‚°ã®ä¿å­˜ãŒå¿…è¦ã§ã™ã€‚
                // ã“ã“ã§ã¯ã”è¦æœ›é€šã‚Šã€Œå¹³æ—¥ã«ãªã£ãŸã‚‰ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆã€ã®æŒ™å‹•ã«ã—ã¾ã™ï¼ˆå½“æ—¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å¢—ãˆã‚‹ï¼‰
                count = 0;
            }
            localStorage.setItem('lastVisitDate', todayStr);
            localStorage.setItem('streakCount', count);
        }

        // ç”»é¢è¡¨ç¤º
        document.getElementById('streak-count').innerText = count;

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ (ä»Šæ—¥ã™ã§ã«æŠ¼ã—ãŸã‹ï¼Ÿ)
        const isDepartedToday = localStorage.getItem('isDepartedToday_' + todayStr);
        const btn = document.getElementById('btn-depart-main');
        if (isDepartedToday === 'true') {
            btn.innerHTML = "<span>âœ… å‡ºç™ºæ¸ˆã¿</span>";
            btn.classList.add('disabled');
        }
    }

    // å‡ºç™ºãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
    function handleDepartClick() {
        let count = parseInt(localStorage.getItem('streakCount')) || 0;
        count++;
        localStorage.setItem('streakCount', count);

        const todayStr = new Date().toDateString();
        localStorage.setItem('isDepartedToday_' + todayStr, 'true');

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã¯ãã®ã¾ã¾è¡Œã‚ã‚Œã¾ã™
        return true;
    }

    // --- 2. å¤©æ°—APIé€£æº (Open-Meteo æ”¹è‰¯ç‰ˆ) ---
    async function updateWeather() {
        const select = document.getElementById('location-select');
        const [lat, lng] = select.value.split(',');

        // weathercode(ã‚¢ã‚¤ã‚³ãƒ³ç”¨), max(æœ€é«˜), min(æœ€ä½) ã‚’å–å¾—
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            const maxTemp = data.daily.temperature_2m_max[0];
            const minTemp = data.daily.temperature_2m_min[0];
            const code = data.daily.weathercode[0];

            // å¤©æ°—ã‚³ãƒ¼ãƒ‰å¤‰æ›
            let icon = "â“";
            if (code === 0) icon = "â˜€ï¸"; // å¿«æ™´
            else if (code <= 3) icon = "â›…"; // æ›‡ã‚Š
            else if (code >= 45 && code <= 48) icon = "ğŸŒ«ï¸"; // éœ§
            else if (code >= 51 && code <= 67) icon = "â˜”"; // é›¨
            else if (code >= 71 && code <= 77) icon = "â˜ƒï¸"; // é›ª
            else if (code >= 95) icon = "âš¡"; // é›·

            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('weather-icon-area').innerText = icon;
            document.getElementById('weather-info').innerHTML =
                `<span class="temp-high">æœ€é«˜ ${maxTemp}â„ƒ</span> / <span class="temp-low">æœ€ä½ ${minTemp}â„ƒ</span>`;

            // æœè£…åˆ¤å®š
            let advice = "";
            if (maxTemp >= 25) advice = "åŠè¢–ã§å¿«é©ï¼æ°´åˆ†è£œçµ¦ã‚’ã€‚";
            else if (maxTemp >= 20) advice = "é•·è¢–ã‚·ãƒ£ãƒ„ãŒãŠã™ã™ã‚ã€‚";
            else if (maxTemp >= 15) advice = "ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³ã‚„ãƒ‘ãƒ¼ã‚«ãƒ¼ã‚’ã€‚";
            else if (maxTemp >= 10) advice = "ã‚³ãƒ¼ãƒˆãŒå¿…è¦ã§ã™ã€‚";
            else advice = "ãƒ€ã‚¦ãƒ³ã‚„ãƒãƒ•ãƒ©ãƒ¼ã§é˜²å¯’ã‚’ï¼";
            document.getElementById('clothing-advice').innerText = "ğŸ§¥ " + advice;

        } catch (e) {
            console.error(e);
            document.getElementById('weather-info').innerText = "å–å¾—å¤±æ•—";
        }
    }

    // --- 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ (JSç”Ÿæˆ + ç¥æ—¥å¯¾å¿œ) ---
    async function renderCalendar() {
        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth(); // 0-11
        const todayD = date.getDate();

        document.getElementById('cal-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;

        // ç¥æ—¥å–å¾—
        let holidays = {};
        try {
            const res = await fetch('https://holidays-jp.github.io/api/v1/date.json');
            holidays = await res.json();
        } catch (e) {}

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = "";

        // æœˆåˆã®ç©ºç™½
        for (let i = 0; i < firstDay.getDay(); i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day';
            grid.appendChild(empty);
        }

        // æ—¥ä»˜ç”Ÿæˆ
        for (let d = 1; d <= lastDay.getDate(); d++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';

            const currentObj = new Date(year, month, d);
            const week = currentObj.getDay();
            const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            // è‰²åˆ†ã‘ã‚¯ãƒ©ã‚¹
            if (week === 0) cell.classList.add('sun');
            else if (week === 6) cell.classList.add('sat');

            if (holidays[dateKey]) cell.classList.add('holiday'); // ç¥æ—¥ä¸Šæ›¸ã
            if (d === todayD) cell.classList.add('today');

            // ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤º (ä»Šæ—¥ã¯æŠ¼ã—ãŸï¼Ÿ)
            const isDepartedToday = localStorage.getItem('isDepartedToday_' + (new Date().toDateString()));
            if (d === todayD && isDepartedToday === 'true') {
                 cell.classList.add('stamped');
                 cell.innerHTML = `<span>${d}</span><span class="stamp-mark">ğŸ’®</span>`;
            } else {
                 cell.innerText = d;
            }

            grid.appendChild(cell);
        }
    }

    // --- ãã®ä»–: SMSãƒªãƒ³ã‚¯æ›´æ–° ---
    function updateSmsLinks() {
        if (!leaderPhone) return;
        const message = `ã€é€£çµ¡ã€‘${userName}ã§ã™ã€‚é€£çµ¡äº‹é …ãŒã‚ã‚Šã¾ã™ã€‚`;
        const href = `sms:${leaderPhone.replace(/-/g, '')}?body=${encodeURIComponent(message)}`;
        const autoLink = document.getElementById('autoSmsLink');
        if (autoLink) autoLink.setAttribute('href', href);
        const manualLink = document.getElementById('manualSmsLink');
        if (manualLink) manualLink.setAttribute('href', href);
    }

    function closeAlert() {
        document.getElementById('lateAlert').style.display = 'none';
        isAlertClosed = true;
    }

    function checkTime() {
        const isDeparted = document.getElementById('btn-depart-main').classList.contains('disabled');
        if (isDeparted || !leaderPhone || !departureTimeStr || isAlertClosed) return;

        const now = new Date();
        const currentMins = now.getHours() * 60 + now.getMinutes();
        const [h, m] = departureTimeStr.split(':').map(Number);
        const deptMins = h * 60 + m;

        if (currentMins > deptMins && currentMins < (deptMins + 180)) {
            const alertBox = document.getElementById('lateAlert');
            if (alertBox.style.display !== 'flex') {
                alertBox.style.display = 'flex';
                const lateMsg = `ã€é…åˆ»é€£çµ¡ã€‘${userName}ã§ã™ã€‚å¯åŠã—ã¾ã—ãŸã€‚æ€¥ã„ã§å‘ã‹ã„ã¾ã™ã€‚`;
                const lateHref = `sms:${leaderPhone.replace(/-/g, '')}?body=${encodeURIComponent(lateMsg)}`;
                document.getElementById('autoSmsLink').setAttribute('href', lateHref);
            }
        }
    }

    // å®Ÿè¡Œ
    window.onload = function() {
        updateSmsLinks();
        initStreakLogic(); // ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯åˆæœŸåŒ–
        updateWeather();   // å¤©æ°—åˆæœŸåŒ–
        renderCalendar();  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
        setInterval(checkTime, 1000);
    };
</script>

</body>
</html>