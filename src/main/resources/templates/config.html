<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>é€šå‹¤ã‚­ãƒ¼ãƒ‘ãƒ¼</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; font-family: sans-serif; }
        .header-status { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .btn-depart { width: 180px; height: 180px; border-radius: 50%; font-size: 1.5rem; font-weight: bold; color: white; border: none; background: linear-gradient(145deg, #28a745, #218838); box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4); margin: 20px auto; display: block; }
        .btn-depart.disabled { background: #ccc; box-shadow: none; pointer-events: none; }

        .card-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* å¤©æ°—ã‚«ãƒ¼ãƒ‰ */
        .weather-info { font-size: 1.1rem; font-weight: bold; color: #333; margin-top: 5px; }
        .clothing-advice { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }

        /* é…åˆ»ã‚¢ãƒ©ãƒ¼ãƒˆ */
        #lateAlert { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.95); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .btn-sms { background: white; color: #d9534f; font-weight: bold; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; text-decoration: none; margin-top: 20px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-day { height: 35px; background: #f1f3f5; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; position: relative; }
        .calendar-day.stamped { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .stamp-mark { position: absolute; font-size: 1.2rem; opacity: 0.8; }

        input[type="time"], input[type="tel"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.2rem; text-align: center; }
        select.form-control { height: 50px; font-size: 1.1rem; border-radius: 8px; }
    </style>
</head>
<body>

<div id="lateAlert">
    <h1 style="font-size: 4rem;">ğŸš¨</h1>
    <h2>é…åˆ»æ³¨æ„ï¼</h2>
    <p>å‡ºç™ºäºˆå®šæ™‚é–“ã‚’éãã¦ã„ã¾ã™ã€‚<br>ãƒªãƒ¼ãƒ€ãƒ¼ã«é€£çµ¡ã—ã¾ã™ã‹ï¼Ÿ</p>
    <a id="autoSmsLink" href="#" class="btn-sms">ğŸ“© SMSã‚’èµ·å‹•</a>
    <button onclick="closeAlert()" class="btn btn-outline-light btn-sm mt-4">é–‰ã˜ã‚‹</button>
</div>

<div class="header-status">
    <div>é€£ç¶šé”æˆ</div>
    <div style="font-size: 3rem; font-weight: bold;">
        <span th:text="${commuteConfigForm.loginStreakDays}">1</span>æ—¥
    </div>
    <div style="font-size: 0.9rem;">
        <span th:text="${commuteConfigForm.userName}">User</span> ã•ã‚“
    </div>
</div>

<div class="container mt-3">

    <div class="card-box">
        <h6 class="border-bottom pb-2 mb-2">â˜€ ä»Šæ—¥ã®å¤©æ°—ã¨æœè£…</h6>
        <div class="form-group">
            <select id="location-select" class="form-control" onchange="updateWeather()" style="height: auto; padding: 5px; font-size: 1rem;">
                <option value="34.693,135.502">å¤§é˜ª (Osaka)</option>
                <option value="35.011,135.768">äº¬éƒ½ (Kyoto)</option>
                <option value="34.690,135.195">å…µåº« (Kobe)</option>
                <option value="35.689,139.692">æ±äº¬ (Tokyo)</option>
            </select>
        </div>
        <div id="weather-display">
            <div class="weather-info" id="weather-info">å–å¾—ä¸­...</div>
            <div class="clothing-advice" id="clothing-advice">ğŸ§¥ ...</div>
        </div>
    </div>

    <div class="text-center mb-4">
        <form th:action="@{/depart}" method="post">
            <input type="hidden" name="user" th:value="${commuteConfigForm.userName}">
            <button type="submit" class="btn-depart" th:classappend="${commuteConfigForm.hasDeparted} ? 'disabled'">
                <span th:text="${commuteConfigForm.hasDeparted} ? 'âœ… å‡ºç™ºæ¸ˆã¿' : 'ğŸ  å‡ºç™ºï¼'"></span>
            </button>
        </form>

        <a id="manualSmsLink" href="#" class="btn btn-outline-danger btn-sm mt-3 px-4 py-2 font-weight-bold" style="border-radius: 50px;">
            ğŸ“© ãƒªãƒ¼ãƒ€ãƒ¼ã¸é€£çµ¡ (SMS)
        </a>
    </div>

    <div class="card-box">
        <h6 class="border-bottom pb-2 mb-3">ğŸ“… é€£ç¶šé”æˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (<span th:text="${currentMonthStr}"></span>)</h6>
        <div class="calendar-grid">
            <div th:each="day : ${calendarDays}" th:classappend="${day != null && day.isStamped} ? 'calendar-day stamped' : 'calendar-day'">
                <span th:if="${day != null}" th:text="${day.day}"></span>
                <span th:if="${day != null && day.isStamped}" class="stamp-mark">ğŸ’®</span>
            </div>
        </div>
    </div>

    <div th:if="${calendarUrl}" class="alert alert-success mt-3 shadow-sm">
        <strong>âœ… è¨­å®šä¿å­˜å®Œäº†</strong><br>
        <span style="font-size: 0.9rem;">Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é€šçŸ¥ã‚’äºˆç´„ï¼š</span>
        <a th:href="${calendarUrl}" target="_blank" class="btn btn-success btn-block mt-2 font-weight-bold">
            ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«é€šçŸ¥ã‚»ãƒƒãƒˆ
        </a>
    </div>

    <form th:action="@{/config/save}" th:object="${commuteConfigForm}" method="post">
        <input type="hidden" th:field="*{userName}">

        <div class="card-box">
            <details open>
                <summary style="font-weight:bold; cursor:pointer;">âš™ï¸ è¨­å®š</summary>

                <div class="mt-3">
                    <label>ğŸ  å‡ºç™ºäºˆå®šæ™‚é–“</label>
                    <input type="time" th:field="*{departureTime}" required>
                </div>

                <div class="mt-3">
                    <label>ğŸ”” é€šçŸ¥ (Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº)</label>
                    <select class="form-control" th:field="*{notificationMinutesBefore}">
                        <option value="5">5åˆ†å‰</option>
                        <option value="10">10åˆ†å‰</option>
                        <option value="15">15åˆ†å‰</option>
                    </select>
                </div>

                <div class="mt-3">
                    <label>ğŸš¨ ãƒªãƒ¼ãƒ€ãƒ¼ã®é›»è©±ç•ªå· (å¿…é ˆ)</label>
                    <input type="tel" th:field="*{leaderPhoneNumber}" placeholder="09012345678">
                </div>

                <button type="submit" class="btn btn-secondary btn-block mt-4">è¨­å®šã‚’ä¿å­˜ã—ã¦æ›´æ–°</button>
            </details>
        </div>
    </form>
</div>

<script th:inline="javascript">
    const isDeparted = /*[[${commuteConfigForm != null ? commuteConfigForm.hasDeparted : false}]]*/ false;
    const departureTimeStr = /*[[${commuteConfigForm != null ? commuteConfigForm.departureTime : '08:00'}]]*/ '08:00';
    const leaderPhone = /*[[${commuteConfigForm != null ? commuteConfigForm.leaderPhoneNumber : ''}]]*/ '';
    const userName = /*[[${commuteConfigForm != null ? commuteConfigForm.userName : ''}]]*/ '';

    let isAlertClosed = false;

    // SMSãƒªãƒ³ã‚¯ç”Ÿæˆ
    function updateSmsLinks() {
        if (!leaderPhone) return;
        const message = `ã€é€£çµ¡ã€‘${userName}ã§ã™ã€‚é€£çµ¡äº‹é …ãŒã‚ã‚Šã¾ã™ã€‚`;
        const href = `sms:${leaderPhone.replace(/-/g, '')}?body=${encodeURIComponent(message)}`;

        const autoLink = document.getElementById('autoSmsLink');
        if (autoLink) autoLink.setAttribute('href', href);

        const manualLink = document.getElementById('manualSmsLink');
        if (manualLink) manualLink.setAttribute('href', href);
    }

    // â˜…è¿½åŠ : å¤©æ°—APIé€£æº (Open-Meteo)
    async function updateWeather() {
        const select = document.getElementById('location-select');
        const [lat, lng] = select.value.split(',');

        // å…¬é–‹API (APIã‚­ãƒ¼ä¸è¦)
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max&timezone=auto`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            const maxTemp = data.daily.temperature_2m_max[0]; // ä»Šæ—¥ã®æœ€é«˜æ°—æ¸©

            document.getElementById('weather-info').innerText = `æœ€é«˜æ°—æ¸©: ${maxTemp}â„ƒ`;

            // æœè£…åˆ¤å®š
            let advice = "";
            if (maxTemp >= 25) advice = "åŠè¢–ã§å¿«é©ï¼æ°´åˆ†è£œçµ¦ã‚’ã€‚";
            else if (maxTemp >= 20) advice = "é•·è¢–ã‚·ãƒ£ãƒ„ãŒãŠã™ã™ã‚ã€‚";
            else if (maxTemp >= 15) advice = "ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³ã‚„ãƒ‘ãƒ¼ã‚«ãƒ¼ã‚’ã€‚";
            else if (maxTemp >= 10) advice = "ã‚³ãƒ¼ãƒˆãŒå¿…è¦ã§ã™ã€‚";
            else advice = "ãƒ€ã‚¦ãƒ³ã‚„ãƒãƒ•ãƒ©ãƒ¼ã§é˜²å¯’ã‚’ï¼";

            document.getElementById('clothing-advice').innerText = "ğŸ§¥ " + advice;

        } catch (e) {
            console.error(e);
            document.getElementById('weather-info').innerText = "å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—";
        }
    }

    window.onload = function() {
        updateSmsLinks();
        updateWeather(); // åˆæœŸè¡¨ç¤ºã§å¤©æ°—ã‚’å–å¾—
    };

    function closeAlert() {
        document.getElementById('lateAlert').style.display = 'none';
        isAlertClosed = true;
    }

    function checkTime() {
        if (isDeparted || !leaderPhone || !departureTimeStr || isAlertClosed) return;

        const now = new Date();
        const currentMins = now.getHours() * 60 + now.getMinutes();
        const [h, m] = departureTimeStr.split(':').map(Number);
        const deptMins = h * 60 + m;

        if (currentMins > deptMins && currentMins < (deptMins + 180)) {
            const alertBox = document.getElementById('lateAlert');
            if (alertBox.style.display !== 'flex') {
                alertBox.style.display = 'flex';
                const lateMsg = `ã€é…åˆ»é€£çµ¡ã€‘${userName}ã§ã™ã€‚å¯åŠã—ã¾ã—ãŸã€‚æ€¥ã„ã§å‘ã‹ã„ã¾ã™ã€‚`;
                const lateHref = `sms:${leaderPhone.replace(/-/g, '')}?body=${encodeURIComponent(lateMsg)}`;
                document.getElementById('autoSmsLink').setAttribute('href', lateHref);
            }
        }
    }
    setInterval(checkTime, 1000);
</script>

</body>
</html>