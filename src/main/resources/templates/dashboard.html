<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <title>ãƒã‚¤ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; font-family: sans-serif; transition: background-color 0.5s; }
        body.night-mode { background-color: #000; color: #fff; }
        body.night-mode .card-box { background-color: #1c1c1e; color: #fff; border: 1px solid #333; }
        body.night-mode .header-status { opacity: 0.7; }

        .header-status { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-depart { width: 180px; height: 180px; border-radius: 50%; font-size: 1.5rem; font-weight: bold; color: white; border: none; background: linear-gradient(145deg, #28a745, #218838); box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4); margin: 20px auto; display: block; transition: transform 0.1s; }
        .btn-depart:active { transform: scale(0.95); }
        .btn-depart.disabled { background: #ccc; box-shadow: none; pointer-events: none; opacity: 0.7; }
        .card-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #eee; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-day { height: 40px; background: #f1f3f5; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; position: relative; color: #333; }
        .sat { background-color: #e6f0ff; color: blue; }
        .sun { background-color: #ffe6e6; color: red; }
        .holiday { background-color: #ffe6e6; color: red; }
        .today { border: 2px solid #333; font-weight: bold; }
        .calendar-day.stamped { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .stamp-mark { position: absolute; font-size: 1.5rem; opacity: 0.8; }

        .btn-sms { cursor: pointer; background: white; color: #d9534f; font-weight: bold; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; text-decoration: none; margin-top: 20px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-sms:active { transform: scale(0.95); background: #eee; }

        .weather-info { font-size: 1.0rem; color: #333; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        body.night-mode .weather-info { color: #fff; }
        .weather-icon-large { font-size: 3.5rem; line-height: 1; }
        .clothing-advice { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }

        #lateAlert { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.98); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; animation: flashRed 1s infinite alternate; }
        @keyframes flashRed { from { background: rgba(220, 53, 69, 0.95); } to { background: rgba(180, 0, 0, 0.95); } }

        .wake-lock-status { font-size: 0.8rem; margin-top: 5px; color: #666; font-weight: bold; }
        body.night-mode .wake-lock-status { color: #4cd137; }
    </style>
</head>
<body>

<audio id="silent-audio" loop playsinline>
    <source src="data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
</audio>

<audio id="real-alarm" loop playsinline>
    <source src="data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUszLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
</audio>

<div id="lateAlert">
    <h1 style="font-size: 5rem;">ğŸ””</h1>
    <h2>æ™‚é–“ã§ã™ï¼</h2>
    <p class="mb-4">å‡ºç™ºäºˆå®šæ™‚é–“ã‚’éãã¦ã„ã¾ã™ã€‚</p>
    <div onclick="launchContactLeaderSms()" class="btn-sms">ğŸ“© é…åˆ»é€£çµ¡ (SMS)</div>
    <button onclick="closeAlert()" class="btn btn-outline-light btn-lg mt-5" style="border-radius: 30px; padding: 10px 40px;">ğŸ”• åœæ­¢</button>
</div>

<div class="header-status">
    <div>é€£ç¶šé”æˆ</div>
    <div style="font-size: 3rem; font-weight: bold;"><span id="streak-count">0</span>æ—¥</div>
    <div style="font-size: 0.9rem;"><span th:text="${userName}">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“</div>
</div>

<div class="container mt-3">
    <div class="card-box">
        <h6 class="border-bottom pb-2 mb-2">â˜€ ä»Šæ—¥ã®å¤©æ°—ã¨æœè£…</h6>
        <select id="location-select" class="form-control mb-3" onchange="updateWeather()">
            <option value="34.69,135.50">å¤§é˜ª (Osaka)</option>
            <option value="34.23,135.17">å’Œæ­Œå±± (Wakayama)</option>
            <option value="35.00,135.87">æ»‹è³€ (Otsu)</option>
            <option value="34.69,135.80">å¥ˆè‰¯ (Nara)</option>
            <option value="35.01,135.76">äº¬éƒ½ (Kyoto)</option>
            <option value="34.69,135.19">å…µåº« (Kobe)</option>
        </select>
        <div id="weather-display" style="text-align:center;">
            <div id="weather-icon-area" class="weather-icon-large">Loading...</div>
            <div class="weather-info" id="weather-info"></div>
            <div class="clothing-advice" id="clothing-advice">ğŸ§¥ ...</div>
        </div>
    </div>

    <div class="text-center mb-4">
        <button type="button" id="btn-depart-main" class="btn-depart" onclick="onDepartClick()">å‡ºç™ºï¼</button>
        <div onclick="launchContactLeaderSms()" class="btn-sms">ğŸ“© ãƒªãƒ¼ãƒ€ãƒ¼ã¸é€£çµ¡ (SMS)</div>
    </div>

    <div class="card-box">
        <h6 class="border-bottom pb-2 mb-3">ğŸ“… é€£ç¶šé”æˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h6>
        <div class="calendar-header">
            <div style="color:red">æ—¥</div>
            <div>æœˆ</div>
            <div>ç«</div>
            <div>æ°´</div>
            <div>æœ¨</div>
            <div>é‡‘</div>
            <div style="color:blue">åœŸ</div>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
    </div>

    <div class="card-box">
        <details open>
            <summary style="font-weight:bold; cursor:pointer;">âš™ï¸ è¨­å®š</summary>

            <div class="mt-3 p-3" style="background:#e3f2fd; border-radius:10px; text-align:center;">
                <label style="font-weight:bold; color:#0d47a1;">ğŸ’¡ iPhoneç”¨è¨­å®š</label>
                <p style="font-size:0.8rem; margin-bottom:10px; color:red; font-weight:bold;">
                    â‘  iPhoneã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã‚¹ã‚¤ãƒƒãƒã‚’OFF<br>
                    â‘¡ éŸ³é‡ã‚’MAXã«ã™ã‚‹<br>
                    â‘¢ ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’å¿…ãšæŠ¼ã™
                </p>
                <button type="button" id="btnWakeLock" class="btn btn-primary btn-block" onclick="startIosMode()">ğŸ”Š ã‚¢ãƒ©ãƒ¼ãƒ å¾…æ©Ÿã‚’é–‹å§‹</button>
                <div id="wakeLockStatus" class="wake-lock-status">å¾…æ©Ÿã—ã¦ã„ã¾ã›ã‚“</div>
            </div>

            <div class="mt-3">
                <label>ğŸ  å‡ºç™ºäºˆå®šæ™‚é–“</label>
                <input type="time" class="form-control" id="departureTime" value="08:00" onchange="saveSettingsLocal()">
            </div>

            <div class="mt-3">
                <label>ğŸš¨ ãƒªãƒ¼ãƒ€ãƒ¼ã®é›»è©±ç•ªå· (å¿…é ˆ)</label>
                <input type="tel" class="form-control" placeholder="09012345678" id="leaderPhoneNumber" oninput="saveSettingsLocal()">
            </div>

            <button type="button" class="btn btn-secondary btn-block mt-4" onclick="saveAndReload()">è¨­å®šã‚’ä¿å­˜ã—ã¦æ›´æ–°</button>
        </details>
    </div>

    <div class="text-center mt-4">
        <a href="/" class="btn btn-link text-muted">åˆ¥ã®åå‰ã§ãƒ­ã‚°ã‚¤ãƒ³</a>
    </div>
</div>

<script th:inline="javascript">
    const CURRENT_USER = /*[[${userName}]]*/ "ã‚²ã‚¹ãƒˆ";
    const JUST_DEPARTED = /*[[${departed}]]*/ false;
    function getKey(keyName) { return keyName + "_" + CURRENT_USER; }

    const silentAudio = document.getElementById('silent-audio');
    const realAlarm = document.getElementById('real-alarm');
    let wakeLock = null;
    let backupTimer = null;

    // --- 1. iPhoneå¯¾å¿œã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆ¶å¾¡ (ãƒ—ãƒ©ã‚¤ãƒŸãƒ³ã‚°) ---
    async function startIosMode() {
        // éŸ³æºã®æº–å‚™ (é›»å­éŸ³ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();

        // 1. ç„¡éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒ
        silentAudio.volume = 0.01;
        try {
            await silentAudio.play();

            // 2. â˜…ã“ã“ãŒé‡è¦â˜… æœ¬ç•ªã‚¢ãƒ©ãƒ¼ãƒ ã‚‚éŸ³é‡0ã§ä¸€ç¬å†ç”Ÿã—ã¦ãŠã (ãƒ—ãƒ©ã‚¤ãƒŸãƒ³ã‚°)
            // ã“ã‚Œã§iPhoneã¯ã€Œã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å†ç”Ÿã—ã¦ã‚ˆã—ã€ã¨èªè­˜ã™ã‚‹
            realAlarm.volume = 0.0;
            await realAlarm.play();
            realAlarm.pause();
            realAlarm.currentTime = 0;
            realAlarm.volume = 1.0; // æœ¬ç•ªç”¨ã«éŸ³é‡ã‚’æˆ»ã™

            // 3. å¿µã®ãŸã‚ã®é›»å­éŸ³ã‚‚ä¸€ç™ºé³´ã‚‰ã™
            playBeep(ctx);

            // 4. UIæ›´æ–° & å¸¸æ™‚ç‚¹ç¯
            requestWakeLock();
            updateWakeLockUI(true);
            alert("ãƒ†ã‚¹ãƒˆéŸ³ãŒé³´ã‚Šã¾ã—ãŸã‹ï¼Ÿ\né³´ã£ã¦ã„ã‚Œã°æº–å‚™OKã§ã™ã€‚\nã“ã®ã¾ã¾ç”»é¢ã‚’é–‰ã˜ãšã«ç½®ã„ã¦ãã ã•ã„ã€‚");

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼ï¼šéŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        }
    }

    // é›»å­éŸ³ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨)
    function playBeep(ctx) {
        if (ctx.state === 'suspended') ctx.resume();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.value = 880;
        gain.gain.value = 0.1;
        osc.start();
        setTimeout(() => osc.stop(), 200);
    }

    // --- 2. ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå‹• ---
    function triggerAlarm() {
        const alertBox = document.getElementById('lateAlert');
        if (alertBox.style.display !== 'flex') {
            alertBox.style.display = 'flex';

            // â‘  æœ¬ç•ªéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ
            realAlarm.play().catch(e => console.log("File Play Error"));

            // â‘¡ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§é›»å­éŸ³ã‚‚é³´ã‚‰ã™ (ãƒ•ã‚¡ã‚¤ãƒ«å¤±æ•—æ™‚ç”¨)
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioContext();
            backupTimer = setInterval(() => playBeep(ctx), 500);

            // â‘¢ ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Android)
            if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);

            // â‘£ é€šçŸ¥
            if (Notification.permission === "granted") new Notification("æ™‚é–“ã§ã™ï¼", { body: "å‡ºç™ºã®æ™‚é–“ã§ã™ï¼" });
        }
    }

    function closeAlert() {
        document.getElementById('lateAlert').style.display = 'none';
        realAlarm.pause();
        realAlarm.currentTime = 0;
        if(backupTimer) clearInterval(backupTimer);
        isAlertClosed = true;
    }

    // --- 3. Wake Lock ---
    async function requestWakeLock() {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => { wakeLock = null; updateWakeLockUI(false); });
        } catch (err) {}
    }

    function updateWakeLockUI(isOn) {
        const btn = document.getElementById('btnWakeLock');
        const status = document.getElementById('wakeLockStatus');
        const body = document.body;
        if (isOn) {
            btn.classList.remove('btn-primary'); btn.classList.add('btn-success');
            btn.innerText = "âœ… å¾…æ©Ÿä¸­ (ç”»é¢ON)";
            status.innerText = "ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„";
            body.classList.add('night-mode');
        } else {
            btn.classList.add('btn-primary'); btn.classList.remove('btn-success');
            btn.innerText = "ğŸ”Š ã‚¢ãƒ©ãƒ¼ãƒ å¾…æ©Ÿã‚’é–‹å§‹";
            status.innerText = "OFF";
            body.classList.remove('night-mode');
        }
    }

    // --- 4. æ™‚é–“ç›£è¦– ---
    let isAlertClosed = false;
    function checkTime() {
        if (isAlertClosed) return;
        const todayStr = new Date().toDateString();
        const isDepartedToday = localStorage.getItem(getKey('isDepartedToday_' + todayStr));
        if (isDepartedToday === 'true') return;

        const timeStr = document.getElementById('departureTime').value;
        if (!timeStr) return;

        const now = new Date();
        const [h, m] = timeStr.split(':').map(Number);
        const scheduledTime = new Date();
        scheduledTime.setHours(h, m, 0, 0);

        if (now > scheduledTime) {
            triggerAlarm();
        }
    }

    // --- ãã®ä»–ãƒ­ã‚¸ãƒƒã‚¯ ---
    function onDepartClick() {
        let phone = document.getElementById('leaderPhoneNumber').value;
        if (!phone) { alert("å…ˆã«ã€Œãƒªãƒ¼ãƒ€ãƒ¼ã®é›»è©±ç•ªå·ã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼"); return; }
        let count = parseInt(localStorage.getItem(getKey('streakCount'))) || 0;
        const todayStr = new Date().toDateString();
        const isDepartedToday = localStorage.getItem(getKey('isDepartedToday_' + todayStr));
        if (isDepartedToday !== 'true') {
            count++;
            localStorage.setItem(getKey('streakCount'), count);
            localStorage.setItem(getKey('isDepartedToday_' + todayStr), 'true');
        }
        const message = `ã€å‡ºç™ºé€£çµ¡ã€‘${CURRENT_USER}ã§ã™ã€‚ä»Šã‹ã‚‰å‡ºç™ºã—ã¾ã™ï¼`;
        const url = `sms:${phone.replace(/-/g, '')}?body=${encodeURIComponent(message)}`;
        window.location.href = url;
        setTimeout(function() { location.reload(); }, 1000);
    }

    function launchContactLeaderSms() {
        let phone = document.getElementById('leaderPhoneNumber').value;
        if (!phone) { alert("è¨­å®šã§ã€Œãƒªãƒ¼ãƒ€ãƒ¼ã®é›»è©±ç•ªå·ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }
        const message = `ã€é€£çµ¡ã€‘${CURRENT_USER}ã§ã™ã€‚é€£çµ¡äº‹é …ãŒã‚ã‚Šã¾ã™ã€‚`;
        const url = `sms:${phone.replace(/-/g, '')}?body=${encodeURIComponent(message)}`;
        window.location.href = url;
    }

    function saveSettingsLocal() {
        const phone = document.getElementById('leaderPhoneNumber').value;
        const time = document.getElementById('departureTime').value;
        localStorage.setItem(getKey('leaderPhone'), phone);
        localStorage.setItem(getKey('departureTime'), time);
    }

    function saveAndReload() {
        saveSettingsLocal();
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        location.reload();
    }

    function initStreakLogic() {
        let count = parseInt(localStorage.getItem(getKey('streakCount'))) || 0;
        let lastDate = localStorage.getItem(getKey('lastVisitDate'));
        const todayStr = new Date().toDateString();
        const dayOfWeek = new Date().getDay();
        if (lastDate !== todayStr) {
            if (dayOfWeek !== 0 && dayOfWeek !== 6) count = 0;
            localStorage.setItem(getKey('lastVisitDate'), todayStr);
            localStorage.setItem(getKey('streakCount'), count);
        }
        document.getElementById('streak-count').innerText = count;
        const isDepartedToday = localStorage.getItem(getKey('isDepartedToday_' + todayStr));
        const btn = document.getElementById('btn-depart-main');
        if (isDepartedToday === 'true') {
            btn.innerHTML = "<span>âœ… å‡ºç™ºæ¸ˆã¿</span>";
            btn.classList.add('disabled');
            btn.onclick = null;
        }
    }

    async function renderCalendar() {
        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth();
        const todayD = date.getDate();
        let holidays = {};
        try { const res = await fetch('https://holidays-jp.github.io/api/v1/date.json'); holidays = await res.json(); } catch (e) {}
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = "";
        for (let i = 0; i < firstDay.getDay(); i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= lastDay.getDate(); d++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            const currentObj = new Date(year, month, d);
            const week = currentObj.getDay();
            const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            if (week === 0) cell.classList.add('sun');
            else if (week === 6) cell.classList.add('sat');
            if (holidays[dateKey]) cell.classList.add('holiday');
            if (d === todayD) cell.classList.add('today');
            const dateStr = currentObj.toDateString();
            const isDeparted = localStorage.getItem(getKey('isDepartedToday_' + dateStr));
            if (isDeparted === 'true') {
                 if(d === todayD) cell.classList.add('stamped');
                 cell.innerHTML = `<span>${d}</span><span class="stamp-mark">ğŸ’®</span>`;
            } else { cell.innerText = d; }
            grid.appendChild(cell);
        }
    }

    async function updateWeather() {
        const select = document.getElementById('location-select');
        const [lat, lng] = select.value.split(',');
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            const max = data.daily.temperature_2m_max[0];
            const min = data.daily.temperature_2m_min[0];
            const code = data.daily.weathercode[0];
            let icon = "â˜ï¸"; if (code === 0) icon = "â˜€ï¸"; else if (code <= 3) icon = "â›…"; else if (code >= 51) icon = "â˜”";
            document.getElementById('weather-icon-area').innerText = icon;
            document.getElementById('weather-info').innerHTML = `<span class="temp-high">æœ€é«˜ ${max}â„ƒ</span> / <span class="temp-low">æœ€ä½ ${min}â„ƒ</span>`;
            let advice = "å­£ç¯€ã®æœè£…ã§ã€‚"; if (max >= 25) advice = "åŠè¢–ã§å¿«é©ï¼"; else if (max >= 15) advice = "ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³ã‚’ã€‚"; else advice = "ã‚³ãƒ¼ãƒˆãŒå¿…è¦ã§ã™ã€‚";
            document.getElementById('clothing-advice').innerText = "ğŸ§¥ " + advice;
        } catch (e) {}
    }

    window.onload = function() {
        const savedPhone = localStorage.getItem(getKey('leaderPhone'));
        const savedTime = localStorage.getItem(getKey('departureTime'));
        if (savedPhone) document.getElementById('leaderPhoneNumber').value = savedPhone;
        if (savedTime) document.getElementById('departureTime').value = savedTime;

        initStreakLogic();
        updateWeather();
        renderCalendar();
        setInterval(checkTime, 1000);
    };
</script>
</body>
</html>